<!DOCTYPE html>


<html lang="en">

<head>
  <title>Revenue Share Contract</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <style>
    body {
      padding-top: 90px;
    }

    .panel-login {
      border-color: #ccc;
      -webkit-box-shadow: 0px 2px 3px 0px rgba(0, 0, 0, 0.2);
      -moz-box-shadow: 0px 2px 3px 0px rgba(0, 0, 0, 0.2);
      box-shadow: 0px 2px 3px 0px rgba(0, 0, 0, 0.2);
    }

    .panel-login>.panel-heading {
      color: #344D7F;
      background-color: #fff;
      border-color: #fff;
      text-align: center;
    }

    .border {
      margin-top: 25px;
      margin-left: 20px;
      margin-right: 20px;
    }

    .loader {
      border: 6px solid silver;
      border-radius: 50%;
      border-top: 6px solid #3498db;
      width: 20px;
      height: 20px;
      -webkit-animation: spin 2s linear infinite;
      animation: spin 2s linear infinite;
    }

    @-webkit-keyframes spin {
      0% {
        -webkit-transform: rotate(0deg);
      }
      100% {
        -webkit-transform: rotate(360deg);
      }
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>

  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <div class="panel panel-login">
        <div class="panel-heading">
          <div class="row border">
            <div class="alert alert-success" id="event">
              <div class="row"><strong>Success!</strong> Your Amount has Transfered...</div>
              <div class="row">Tx hash : <a href="#" id="hash" target="_blank"></a></div>
            </div> 
          </div>
          <div id="DApp">
            <div class="row border">
              <h3>Revenue Share DApp</h3>
            </div>
            <div class="row border">
              <div class="col-sm-6">
                <h5>Provider Address</h5>
                <input type="text" name="name" id="name" class="form-control" disabled />
              </div>
              <div class="col-sm-3">
                <h5>Balance</h5>
                <input type="text" name="balance" id="balance" class="form-control" disabled />
              </div>
              <div class="col-sm-3">
                <h5>Percentage</h5>
                <input type="text" name="balance" value="100" class="form-control" disabled />
              </div>
            </div>
            <div class="row border">
              <div class="col-sm-6">
                <input type="text" name="vendor1" id="vendor1" tabindex="1" class="form-control" placeholder="Vendor1 Address" value="" onblur="getbalance1(this.value)"
                  required>
              </div>
              <div class="col-sm-3">
                <input type="text" name="v1balance" id="v1balance" tabindex="1" class="form-control" value="" disabled required>
              </div>
              <div class="col-sm-3">
                <input type="text" name="v1amount" id="v1amount" tabindex="1" class="form-control" placeholder="Percentage" value="" onblur="vendor1ProfileOnChange(this.value)"
                  required>
              </div>

            </div>
            <div class="row border">
              <div class="col-sm-6">
                <input type="text" name="vendor2" id="vendor2" tabindex="1" class="form-control" placeholder="Vendor2 Address" value="" onblur="getbalance2(this.value)"
                  required>
              </div>
              <div class="col-sm-3">
                <input type="text" name="v2balance" id="v2balance" tabindex="1" class="form-control" placeholder="" value="" disabled>
              </div>
              <div class="col-sm-3">
                <input type="text" name="v2amount" id="v2amount" tabindex="1" class="form-control" disabled placeholder="Percentage" value="">
              </div>
            </div>
            <div class="row border">
              <div class="col-sm-12">
                <input type="text" name="amount" id="amount" tabindex="1" class="form-control" placeholder="Total Amount has to be transferred"
                  value="" required>
              </div>
            </div>
            <div class="row border" id="load">
              <center>
                <div class="loader">
                </div>
              </center>
            </div>
            <div class="row border">
              <center>
                <button id="button" class="btn btn-primary btn-lg"> Submit </button>
              </center>
            </div>
          </div>


        </div>
      </div>
    </div>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script>
   
    function vendor1ProfileOnChange(value) {
      document.getElementById("v2amount").value = 100 - value;

    }
    function getbalance1(value) {
      window.web3.eth.getBalance(value, (err, bal) => {
        document.getElementById("v1balance").value = window.web3.fromWei(bal, "ether") + " ETH";
      })
    }
    function getbalance2(value) {
      window.web3.eth.getBalance(value, (err, bal) => {
        document.getElementById("v2balance").value = window.web3.fromWei(bal, "ether") + " ETH";
      })
    }
    window.addEventListener('load', function () {
      if (typeof web3 !== 'undefined') {
        window.web3 = new Web3(web3.currentProvider);
        console.log("MetaMask Injected......!");
        console.log(window.web3.currentProvider);
        window.web3.eth.getAccounts((err, accounts) => {
          //console.log(accounts);
          document.getElementById("name").value = accounts[0];
          window.web3.eth.getBalance(accounts[0], (err, bal) => {
            document.getElementById("balance").value = window.web3.fromWei(bal, "ether") + " ETH";
          });
        });

      } else {
        console.log('No web3? You should consider trying MetaMask!')
        window.web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
      }
    })




    $(document).ready(function () {
      $("#event").hide();
      $("#DApp").show();
      $("#load").hide();
      $("#button").click(function () {
        $("#load").show();
        var _vendor1 = document.getElementById("vendor1").value;
        var _vendor2 = document.getElementById("vendor2").value;
        var _vendor1Amount = document.getElementById("v1amount").value;
        var _vendor2Amount = document.getElementById("v2amount").value;
        var _amount = document.getElementById("amount").value;


        var abi = [{ "constant": false, "inputs": [{ "name": "_vendor1", "type": "address" }, { "name": "_vendor2", "type": "address" }, { "name": "percent1", "type": "uint256" }], "name": "splitRevenue", "outputs": [], "payable": true, "type": "function" }, { "anonymous": false, "inputs": [{ "indexed": false, "name": "vendor1", "type": "address" }, { "indexed": false, "name": "amount1", "type": "uint256" }, { "indexed": false, "name": "vendor2", "type": "address" }, { "indexed": false, "name": "amount2", "type": "uint256" }], "name": "Transfered", "type": "event" }];

        window.web3 = new Web3(web3.currentProvider);
        var address = "0xb25a17c80aaf0f7a9dc170602d98ecaf3cf46a8c";
        var contractObj = window.web3.eth.contract(abi).at(address);

        contractObj.Transfered().watch(function (error, result) {
          if (!error) {
            console.log(result);
            $("#event").show();
            $("#DApp").show();
            $("#load").hide();
          } else {
            console.log("Error! + ", error);
          }
        });

        return new Promise((resolve, reject) => {
          contractObj.splitRevenue(_vendor1, _vendor2, _vendor1Amount, {
            value: window.web3.toWei(document.getElementById("amount").value, 'ether')

          }, function (err, res) {
            if (!err) {
              console.log("Transaction Hash ", res);
              document.getElementById("hash").innerHTML = res;
                  $("#hash").attr("href", "https://rinkeby.etherscan.io/tx/"+res)
             
              resolve(res)
            } else {
              console.log("Error ", err);
            }

          })
        })


      })
    });

  </script>
</body>

</html>
